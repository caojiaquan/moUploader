<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<form>
    <input name="file" multiple="multiple" type="file"><br>
    <!--<progress value="0" max="1"></progress><br>-->
    <div></div>
    <button id="pause" disabled="disabled">pause</button>
    <button id="continue" disabled="disabled">continue</button>
</form>
<script src="bower_components/js-md5/build/md5.min.js"></script>
<script src="mouploader.js"></script>
<script>
    var form = document.querySelector('form')
    var btnPause = form.querySelector('#pause')
    var btnContinue = form.querySelector('#continue')
    var inputFile = form.querySelector('input[type=file]')
//    var progress = form.querySelector('progress')
    var div = form.querySelector('div')

    var SIZE_50M = 1024 * 1024 * 50

    /* functions begin */

    function setProgress(val, prog) {
        prog.value = val;
    }

    function log() {
        console.log.apply(null, arguments)
    }

    function setBtnPauseDisabled(val) {
        btnPause.disabled = !!val
    }
    function setBtnContinueDisabled(val) {
        btnContinue.disabled = !!val
    }
    
    function appendUploading(file, index) {
        var html = file.name+' <progress max="1" value="0"></progress>'
            + '<button onclick="mo.pause('+index+')">pause</button>'
                + '<button onclick="mo.continue('+index+')">continue</button>'
        var inner = document.createElement('div');
        inner.innerHTML = html
        div.appendChild(inner);
        return inner.querySelector('progress')
    }
    /* functions end */

    form.addEventListener('submit', function (e) {
        e.preventDefault()
    })

    btnPause.addEventListener('click', function (e) {
        e.preventDefault();
        mo.pause(-1);
        setBtnContinueDisabled(false)
    })
    btnContinue.addEventListener('click', function (e) {
        e.preventDefault();
        mo.continue(-1);
        setBtnPauseDisabled(false)
    })
    inputFile.addEventListener('change', function (e) {
        e.preventDefault();

        setBtnPauseDisabled(false);
        setBtnContinueDisabled(false);

        var self = this;
        mo = MoUploader({
            files: this.files,
            uploadUrl: 'upload',
            request: false,
            onBeforeUpload: function (index) {
                if(index>=0) {
                    self.files[index].progress = appendUploading(self.files[index], index)
                }
            },
            onOverAllProgress: function (index, loaded, total) {

                console.log(loaded / total)
                setProgress(loaded / total, self.files[index].progress)
            },
            onLoad: function (index, chunkIndex, chunksNum) {
                console.log('onLoad', this, arguments)
            },
            onAbort: function (index, chunkIndex, chunksNum) {
                console.log('onAbort', this, arguments)
            },
            onError: function (index, chunkIndex, chunksNum) {
                console.log('onError', this, arguments)
            },
            onContinue: function (file, md5, index) {
                return new Promise(function(reslove, reject) {
                    var xhr = new XMLHttpRequest()
                    xhr.open('GET', '/getFile?md5='+md5, true);
                    xhr.send(null);
                    xhr.addEventListener('readystatechange', function () {
                        if(xhr.readyState === 4 && xhr.status === 200) {
                            var json = JSON.parse(xhr.responseText);
                            log(json)
                            reslove(json.pos)
                        }
                    })
                })
            }
        })

    })
</script>
</body>
</html>